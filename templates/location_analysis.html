{% extends "base.html" %}

{% block title %}Location Analysis - FraudGuard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="mb-4">
        <h2 class="mb-1">Location Analysis</h2>
        <p class="text-muted mb-0">Track transactions by location and identify unauthorized origins</p>
    </div>
    
    <div class="row g-4">
        <!-- Location Statistics -->
        <div class="col-md-8">
            <div class="table-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Transactions by Location</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Total Transactions</th>
                                    <th>Fraud Transactions</th>
                                    <th>Fraud Rate</th>
                                    <th>Avg Risk Score</th>
                                    <th>Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loc in locations %}
                                <tr class="{% if loc.Location in ['Unknown Location', 'Suspicious IP'] %}table-danger{% endif %}">
                                    <td>
                                        {% if loc.Location in ['Unknown Location', 'Suspicious IP'] %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-exclamation-triangle me-1"></i>{{ loc.Location }}
                                        </span>
                                        {% else %}
                                        <i class="bi bi-geo-alt text-muted me-1"></i>{{ loc.Location }}
                                        {% endif %}
                                    </td>
                                    <td>{{ loc.TotalTxns|int }}</td>
                                    <td>
                                        <span class="{% if loc.FraudTxns > 0 %}text-danger fw-bold{% endif %}">
                                            {{ loc.FraudTxns|int }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px; width: 60px;">
                                                <div class="progress-bar {% if loc.FraudRate > 50 %}bg-danger{% elif loc.FraudRate > 20 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     style="width: {{ loc.FraudRate }}%"></div>
                                            </div>
                                            <span class="{% if loc.FraudRate > 50 %}text-danger{% elif loc.FraudRate > 20 %}text-warning{% else %}text-success{% endif %}">
                                                {{ loc.FraudRate }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="{% if loc.AvgRiskScore > 50 %}text-danger{% elif loc.AvgRiskScore > 30 %}text-warning{% else %}text-success{% endif %}">
                                            {{ "{:.1f}".format(loc.AvgRiskScore) }}%
                                        </span>
                                    </td>
                                    <td>${{ "{:,.0f}".format(loc.TotalAmount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Unauthorized Locations Summary -->
        <div class="col-md-4">
            <div class="table-card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Unauthorized Locations</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Transactions from unauthorized or suspicious locations are automatically flagged as high-risk.</p>
                    
                    <div class="alert alert-danger">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total Unauthorized Transactions</span>
                            <span class="badge bg-danger fs-5">{{ unauthorized_txns|length }}</span>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Flagged Location Types:</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-geo-alt text-danger me-2"></i>Unknown Location</span>
                            <span class="badge bg-danger rounded-pill">
                                {{ unauthorized_txns|selectattr('SenderLocation', 'equalto', 'Unknown Location')|list|length }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-wifi text-danger me-2"></i>Suspicious IP / VPN</span>
                            <span class="badge bg-danger rounded-pill">
                                {{ unauthorized_txns|selectattr('SenderLocation', 'equalto', 'Suspicious IP')|list|length }}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Location Risk Chart -->
            <div class="table-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Fraud Rate by Location</h5>
                </div>
                <div class="card-body">
                    <canvas id="locationChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unauthorized Transactions Table -->
    {% if unauthorized_txns %}
    <div class="table-card mt-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Unauthorized Location Transactions</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Date</th>
                            <th>Sender</th>
                            <th>Location</th>
                            <th>Receiver</th>
                            <th>Amount</th>
                            <th>Risk Score</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in unauthorized_txns[:20] %}
                        <tr>
                            <td><span class="text-primary">{{ txn.TransactionID }}</span></td>
                            <td><small>{{ txn.Timestamp }}</small></td>
                            <td>{{ txn.SenderName }}</td>
                            <td><span class="badge bg-danger">{{ txn.SenderLocation }}</span></td>
                            <td>{{ txn.ReceiverName }}</td>
                            <td class="fw-bold">${{ "{:,.2f}".format(txn.Amount) }}</td>
                            <td>
                                <span class="text-danger">{{ txn.RiskScore }}%</span>
                            </td>
                            <td>
                                <a href="{{ url_for('transaction_detail', transaction_id=txn.TransactionID) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Location Fraud Rate Chart
const ctx = document.getElementById('locationChart').getContext('2d');
const locationData = {{ locations | tojson }};

// Sort by fraud rate and take top 8
const sortedData = locationData.sort((a, b) => b.FraudRate - a.FraudRate).slice(0, 8);

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: sortedData.map(l => l.Location),
        datasets: [{
            label: 'Fraud Rate %',
            data: sortedData.map(l => l.FraudRate),
            backgroundColor: sortedData.map(l => 
                l.Location === 'Unknown Location' || l.Location === 'Suspicious IP' 
                    ? '#dc2626' 
                    : l.FraudRate > 50 ? '#f59e0b' : '#2563eb'
            ),
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
